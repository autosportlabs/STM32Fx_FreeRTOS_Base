#include <FreeRTOS.h>
#include <timers.h>
#include <task.h>

#include <usbd_cdc_vcp.h>


uint8_t nyan1[] = {111, 32, 32, 43, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
	43, 32, 32, 32, 32, 32, 32, 32, 32, 43, 13, 10, 111, 32, 32, 32, 32, 32,
	 32, 32, 32, 32, 32, 43, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
	 32, 32, 32, 32, 32, 32, 32, 32, 111, 13, 10, 32, 32, 32, 32, 111, 32,
	32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 43, 32,
	32, 32, 32, 32, 32, 32, 32, 32, 32, 13, 10, 43, 32, 32, 32, 32, 32, 32,
	111, 32, 32, 32, 32, 32, 43, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
	32, 32, 32, 111, 32, 32, 32, 32, 13, 10, 32, 111, 32, 32, 32, 32, 32, 43,
	32, 32, 32, 32, 32, 32, 32, 32, 111, 32, 32, 32, 32, 32, 32, 32, 32, 32,
	32, 32, 32, 32, 32, 32, 43, 13, 10, 95, 45, 95, 45, 95, 45, 95, 45, 95,
	45, 95, 45, 95, 45, 44, 45, 45, 45, 45, 45, 45, 44, 32, 32, 111, 32, 32,
	32, 32, 32, 32, 43, 32, 13, 10, 45, 95, 45, 95, 45, 95, 45, 95, 45, 95,
	45, 95, 45, 95, 124, 32, 32, 32, 47, 92, 95, 47, 92, 32, 32, 32, 32, 43,
	32, 32, 32, 32, 32, 13, 10, 95, 45, 95, 45, 95, 45, 95, 45, 95, 45, 95,
	45, 95, 126, 124, 95, 95, 40, 32, 94, 32, 46, 94, 41, 32, 32, 32, 32, 32,
	111, 32, 32, 32, 13, 10, 45, 95, 45, 95, 45, 95, 45, 95, 45, 95, 45, 95,
	45, 95, 32, 32, 34, 34, 32, 32, 34, 34, 32, 32, 32, 32, 32, 32, 32, 13,
	10, 43, 32, 32, 32, 32, 32, 32, 43, 32, 32, 32, 32, 32, 111, 32, 32, 32,
	32, 32, 32, 32, 32, 111, 32, 32, 32, 32, 32, 32, 43, 32, 32, 32, 13, 10,
	111, 32, 32, 32, 32, 32, 32, 32, 32, 43, 32, 32, 32, 32, 32, 32, 32, 32,
	32, 32, 32, 32, 32, 32, 32, 32, 111, 32, 32, 32, 32, 32, 43, 13, 10, 43,
	32, 32, 32, 32, 32, 32, 111, 32, 32, 32, 32, 32, 32, 32, 32, 32, 43, 32,
	32, 32, 32, 32, 43, 32, 32, 32, 32, 32, 32, 32, 111, 32, 13, 10, 32, 32,
	32, 32, 43, 32, 32, 32, 32, 32, 32, 32, 32, 32, 43, 32, 32, 32, 32, 32,
	32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 13, 10, 32, 32, 32,
	32, 32, 32, 32, 43, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 111, 32,
	32, 32, 32, 32, 32, 32, 32, 43, 32, 32, 32, 32, 13, 10};

uint8_t nyan2[] = {43, 32, 32, 32, 32, 32, 32, 111, 32, 32, 32, 32, 32, 43, 32,
	 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 111, 32, 32, 32, 32,
	 13, 10, 32, 32, 32, 32, 43, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
	32, 32, 111, 32, 32, 32, 32, 32, 43, 32, 32, 32, 32, 32, 32, 32, 43, 13,
	10, 111, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 43, 32, 32, 32, 32, 32,
	32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 13, 10,
	32, 32, 32, 32, 111, 32, 32, 43, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
	32, 43, 32, 32, 32, 32, 32, 32, 32, 32, 43, 32, 32, 32, 32, 13, 10, 43,
	32, 32, 32, 32, 32, 32, 32, 32, 111, 32, 32, 32, 32, 32, 111, 32, 32, 32,
	 32, 32, 32, 32, 43, 32, 32, 32, 32, 32, 32, 32, 32, 111, 13, 10, 45, 95,
	 45, 95, 45, 95, 45, 95, 45, 95, 45, 95, 45, 95, 44, 45, 45, 45, 45, 45,
	45, 44, 32, 32, 32, 32, 32, 32, 111, 32, 32, 32, 32, 13, 10, 95, 45, 95,
	45, 95, 45, 95, 45, 95, 45, 95, 45, 95, 45, 124, 32, 32, 32, 47, 92, 95,
	 47, 92, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 13, 10, 45, 95, 45, 95,
	 45, 95, 45, 95, 45, 95, 45, 95, 45, 126, 124, 95, 95, 40, 32, 94, 32,
	46, 94, 41, 32, 32, 43, 32, 32, 32, 32, 32, 43, 13, 10, 95, 45, 95, 45,
	95, 45, 95, 45, 95, 45, 95, 45, 95, 45, 34, 34, 32, 32, 34, 34, 32, 32,
	32, 32, 32, 32, 32, 32, 32, 13, 10, 43, 32, 32, 32, 32, 32, 32, 111, 32,
	32, 32, 32, 32, 32, 32, 32, 32, 111, 32, 32, 32, 43, 32, 32, 32, 32, 32,
	 32, 32, 111, 32, 32, 32, 13, 10, 32, 32, 32, 32, 43, 32, 32, 32, 32, 32,
	 32, 32, 32, 32, 43, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
	32, 32, 32, 32, 32, 13, 10, 111, 32, 32, 32, 32, 32, 32, 32, 32, 111, 32,
	 32, 32, 32, 32, 32, 32, 32, 32, 111, 32, 32, 32, 32, 32, 32, 111, 32,
	32, 32, 32, 32, 43, 13, 10, 32, 32, 32, 32, 111, 32, 32, 32, 32, 32, 32,
	 32, 32, 32, 32, 32, 43, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32, 32,
	 32, 32, 32, 32, 13, 10, 43, 32, 32, 32, 32, 32, 32, 43, 32, 32, 32, 32,
	 32, 111, 32, 32, 32, 32, 32, 32, 32, 32, 111, 32, 32, 32, 32, 32, 32,
	43, 32, 32, 32, 13, 10};


void nyan_task(void *params)
{
	(void)params;
	/* 250Ms delay */
	const portTickType heartbeat_delay = 250 / portTICK_RATE_MS;

	uint8_t *nyan_ptr = nyan2;
	uint32_t d_len = sizeof(nyan2);
	int i;

	while(1){
		i = 0;
		while (d_len--){
			VCP_DataTx(&nyan_ptr[i], 1);
			i++;
		}

		if (nyan_ptr == nyan1) {
			nyan_ptr = nyan2;
			d_len = sizeof(nyan2);
		} else {
			nyan_ptr = nyan1;
			d_len = sizeof(nyan1);
		}

		/* Pause for a bit before moving on */
		vTaskDelay(heartbeat_delay);
		VCP_DataTx("\x1B[2J", 4);
	}
}
